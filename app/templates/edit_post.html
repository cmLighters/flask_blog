{% extends 'base.html' %}
{% import 'bootstrap/wtf.html' as wtf %}
{% import '_macros.html' as macros %}

{% block title %} Lighters - Edit post {% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='editor_md/css/editormd.min.css') }}" />
{% endblock %}

{#{% block body %}#}
    {% block navbar %}
        {{  super() }}
        {% endblock %}

{% block content %}
<div class="container" style="width:100%">
{% block page_content %}
    <div style="display:none">
        {{ wtf.quick_form(form) }}
    </div>
    <div id="layout">
        <div class="edit-post-hint" style="width: 90%;margin: auto;margin-bottom: 20px;text-align: center;">
            <p>使用 <a href="https://pandao.github.io/editor.md/">Editor.md</a> 开源 Markdown 编辑器，支持
                <a href="https://guides.github.com/features/mastering-markdown/">Markdown 语法
                </a>。请点击上方保存按钮来保存文章。
            </p>
        </div>
        <div id="test-editormd"></div>
    </div>
{% endblock %}
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='editor_md/editormd.min.js') }}"></script>
    <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
    <script>
    var testEditor;

    $(function() {
        {% if post_id %}
            url = '{{ url_for('main.get_post_content', id=post_id, _external=True) }}'   // 编辑文章，返回之前保存的文章内容
        {% else %}
            url = '{{ url_for('main.get_post_content', id=0, _external=True) }}'   // 写新文章，返回''来初始化编辑器
        {% endif %}
        $.get(url, function(content){
            testEditor = editormd("test-editormd", {
                width: "100%",
                height: 750,
                path : "{{ url_for('static', filename='editor_md/lib/') }}",
                theme : "dark",
                previewTheme : "dark",
                editorTheme : "pastel-on-dark",
                markdown : content,
                codeFold : true,
                //syncScrolling : false,
                saveHTMLToTextarea : true,    // 保存 HTML 到 Textarea
                searchReplace : true,
                //watch : false,                // 关闭实时预览
                htmlDecode : "style,script,iframe|on*",            // 开启 HTML 标签解析，为了安全性，默认不开启
                //toolbar  : false,             //关闭工具栏
                //previewCodeHighlight : false, // 关闭预览 HTML 的代码块高亮，默认开启
                emoji : true,
                taskList : true,
                tocm            : true,         // Using [TOCM]
                tex : true,                   // 开启科学公式TeX语言支持，默认关闭
                flowChart : true,             // 开启流程图支持，默认关闭
                sequenceDiagram : true,       // 开启时序/序列图支持，默认关闭,
                //dialogLockScreen : false,   // 设置弹出层对话框不锁屏，全局通用，默认为true
                //dialogShowMask : false,     // 设置弹出层对话框显示透明遮罩层，全局通用，默认为true
                //dialogDraggable : false,    // 设置弹出层对话框不可拖动，全局通用，默认为true
                //dialogMaskOpacity : 0.4,    // 设置透明遮罩层的透明度，全局通用，默认值为0.1
                //dialogMaskBgColor : "#000", // 设置透明遮罩层的背景颜色，全局通用，默认为#fff
                imageUpload : true,
                imageFormats : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
                imageUploadURL : "./php/upload.php",
                onload : function() {
                    console.log('onload', this);
                    //this.fullscreen();
                    //this.unwatch();
                    //this.watch().fullscreen();

                    //this.setMarkdown("#PHP");
                    //this.width("100%");
                    //this.height(480);
                    //this.resize("100%", 640);
                }
            });
        });
    });

    $('.edit-post-hint').delay(15000).fadeOut();

    $('.navbar-post-commit-btn').click(function () {
        markdown = $('textarea.editormd-markdown-textarea').val();
        if (!markdown.trim()) {
            alert('请勿提交空文档');
            return false;
        }
        $('textarea#flask-pagedown-content').val(markdown);
        $('#post-form-submit').click();
    });


    </script>

{% endblock %}
